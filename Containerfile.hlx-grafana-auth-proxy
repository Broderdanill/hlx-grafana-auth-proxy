# Containerfile.hlx-grafana-auth-proxy
FROM python:3.12-slim

# Lite bra Python defaults
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1

# Skapa en icke-root-användare
# -r = systemkonto, ingen home / shell-krusiduller
RUN useradd -r -u 1000 appuser

WORKDIR /app

# Kopiera requirements först (bättre caching i Docker/Podman)
COPY requirements.txt .

# Installera Python-dependencies
RUN pip install --no-cache-dir -r requirements.txt

# Kopiera applikationskoden
COPY app.py .

# Sätt rätt ägare på app-mappen så att appuser kan läsa/köra
RUN chown -R appuser:appuser /app

# BYT TILL ICKE-ROOT-ANVÄNDARE HÄR
USER appuser

ENV GRAFANA_INTERNAL_URL=http://127.0.0.1:3000

EXPOSE 8080

CMD ["uvicorn", "app:app", "--host", "0.0.0.0", "--port", "8080"]
